<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Cruciflix - Plataforma de Streaming Cat√≥lica">
    <title>Cruciflix - Dashboard</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/responsive.css">

    <style>
        /* Dashboard Styles */
        .dashboard-page {
            padding-top: 70px;
            min-height: 100vh;
        }

        .hero-section {
            height: 500px;
            background: linear-gradient(to bottom, transparent 0%, var(--color-bg-dark) 100%),
                url('https://images.unsplash.com/photo-1488998427799-e3362cec87c3?q=80&w=2340') center/cover;
            display: flex;
            align-items: flex-end;
            padding: var(--spacing-3xl);
            margin-bottom: var(--spacing-3xl);
        }

        .hero-content {
            max-width: 600px;
            z-index: 1;
        }

        .hero-title {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--spacing-md);
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
        }

        .hero-description {
            font-size: var(--font-size-lg);
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-xl);
            line-height: 1.6;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.8);
        }

        .hero-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        /* Quick Access Cards */
        .quick-access {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-3xl);
        }

        .quick-card {
            background: var(--color-bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: 1px solid transparent;
        }

        .quick-card:hover {
            transform: translateY(-5px);
            border-color: var(--color-primary);
            box-shadow: var(--shadow-lg);
        }

        .quick-card-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .quick-card-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .quick-card-description {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Profile Section */
        .profile-section {
            background: var(--color-bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-4xl);
            font-weight: 700;
            box-shadow: var(--shadow-lg);
        }

        .profile-info h2 {
            margin-bottom: var(--spacing-xs);
        }

        .profile-email {
            color: var(--color-text-secondary);
        }

        .profile-form {
            display: grid;
            gap: var(--spacing-lg);
            max-width: 500px;
        }

        /* Watch History */
        .history-section {
            background: var(--color-bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
        }

        .history-grid {
            display: grid;
            gap: var(--spacing-md);
        }

        .history-item {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .history-item:hover {
            background: var(--color-bg-medium);
            transform: translateX(4px);
        }

        .history-thumbnail {
            width: 120px;
            height: 70px;
            border-radius: var(--radius-sm);
            background-size: cover;
            background-position: center;
            background-color: var(--color-bg-dark);
            flex-shrink: 0;
        }

        .history-info {
            flex: 1;
        }

        .history-title {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .history-progress-text {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            margin-bottom: var(--spacing-xs);
        }

        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: var(--color-bg-dark);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: var(--radius-full);
        }

        /* Continue Watching Section */
        .continue-watching {
            margin-bottom: var(--spacing-3xl);
        }

        .videos-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }
    </style>
</head>

<body>

    <!-- Header Navigation -->
    <header class="main-header">
        <div class="container">
            <nav class="nav-container">
                <div class="logo">Cruci<span class="accent">flix</span></div>

                <button class="mobile-menu-toggle" id="mobile-menu-toggle">‚ò∞</button>

                <div class="main-nav">
                    <ul>
                        <li><a href="dashboard.html">In√≠cio</a></li>
                        <li><a href="catalogo.html">Cat√°logo</a></li>
                    </ul>
                </div>

                <div class="user-menu">
                    <div class="user-menu-btn" id="user-menu-btn">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <span id="user-name">Usu√°rio</span>
                    </div>
                    <div class="user-menu-dropdown" id="user-menu-dropdown">
                        <a href="#profile-section" onclick="scrollToProfile()">Meu Perfil</a>
                        <a href="#" id="admin-link" style="display:none;">Painel Admin</a>
                        <a href="#" onclick="handleLogout(event)">Sair</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="dashboard-page">

        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">Bem-vindo ao Cruciflix</h1>
                <p class="hero-description">
                    Assista aos melhores filmes, s√©ries e document√°rios cat√≥licos. Fortale√ßa sua f√© enquanto se entret√©m.
                </p>
                <div class="hero-actions">
                    <button class="btn btn-primary" onclick="window.location.href='catalogo.html'">Explorar Cat√°logo</button>
                    <button class="btn btn-secondary" onclick="window.location.href='catalogo.html'">üë∂ √Årea Kids</button>
                </div>
            </div>
        </section>

        <div class="container">

            <!-- Quick Access -->
            <section class="quick-access">
                <div class="quick-card" onclick="window.location.href='catalogo.html'">
                    <div class="quick-card-icon">üé¨</div>
                    <div class="quick-card-title">Cat√°logo Completo</div>
                    <div class="quick-card-description">Explore todos os v√≠deos dispon√≠veis</div>
                </div>
                <div class="quick-card" onclick="window.location.href='catalogo.html'">
                    <div class="quick-card-icon">üë∂</div>
                    <div class="quick-card-title">Conte√∫do Kids</div>
                    <div class="quick-card-description">V√≠deos seguros para crian√ßas</div>
                </div>
                <div class="quick-card" onclick="scrollToHistory()">
                    <div class="quick-card-icon">üì∫</div>
                    <div class="quick-card-title">Continuar Assistindo</div>
                    <div class="quick-card-description">Retome de onde parou</div>
                </div>
                <div class="quick-card" onclick="scrollToProfile()">
                    <div class="quick-card-icon">üë§</div>
                    <div class="quick-card-title">Meu Perfil</div>
                    <div class="quick-card-description">Gerencie sua conta</div>
                </div>
            </section>

            <!-- Continue Watching -->
            <section class="continue-watching" id="continue-section">
                <h2 class="section-title">Continuar Assistindo</h2>
                <div class="videos-row" id="continue-watching-container">
                    <!-- Loaded dynamically -->
                </div>
            </section>

            <!-- Watch History -->
            <section class="history-section" id="history-section">
                <h2>Hist√≥rico de Visualiza√ß√£o</h2>
                <div class="history-grid" id="history-container">
                    <!-- Loaded dynamically -->
                </div>
            </section>

            <!-- Profile Section -->
            <section class="profile-section" id="profile-section">
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profile-avatar-large">U</div>
                    <div class="profile-info">
                        <h2 id="profile-name">Carregando...</h2>
                        <p class="profile-email" id="profile-email"></p>
                    </div>
                </div>

                <h3 style="margin-bottom: var(--spacing-lg);">Configura√ß√µes da Conta</h3>

                <form class="profile-form" id="profile-form" onsubmit="handleProfileUpdate(event)">
                    <div class="form-group">
                        <label class="form-label">Nome de Exibi√ß√£o</label>
                        <input type="text" id="display-name" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="email-display" class="form-input" disabled>
                        <small style="color: var(--color-text-muted);">O email n√£o pode ser alterado</small>
                    </div>

                    <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                        <button type="button" class="btn btn-ghost" style="border-color: var(--color-warning); color: var(--color-warning);" onclick="handlePasswordReset()">
                            Redefinir Senha
                        </button>
                    </div>
                </form>
            </section>

        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- App Scripts -->
    <script src="../scripts/app-core.js"></script>
    <script src="../scripts/app-catalog.js"></script>

    <script>
        let currentUser = null;

        // Initialize page
        window.authModule.onAuthStateChanged(async (authState) => {
            if (!authState.loggedIn) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = authState.user;

            // Update user info in header
            const displayName = currentUser.displayName || currentUser.email;
            const initials = displayName.charAt(0).toUpperCase();
            
            document.getElementById('user-name').textContent = displayName;
            document.getElementById('user-avatar').textContent = initials;

            // Update profile section
            document.getElementById('profile-name').textContent = displayName;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-avatar-large').textContent = initials;
            document.getElementById('display-name').value = currentUser.displayName || '';
            document.getElementById('email-display').value = currentUser.email;

            // Show admin link if admin
            if (authState.isAdmin) {
                document.getElementById('admin-link').style.display = 'block';
                document.getElementById('admin-link').href = 'admin.html';
            }

            // Load user data
            await loadContinueWatching();
            await loadWatchHistory();
        });

        // Load continue watching (incomplete videos)
        async function loadContinueWatching() {
            const container = document.getElementById('continue-watching-container');
            const progressList = await window.firestoreModule.getUserProgress();
            
            // Filter to only incomplete videos
            const incompleteProgress = progressList.filter(p => !p.completed && p.watchTime > 0);
            
            if (incompleteProgress.length === 0) {
                container.innerHTML = '<p class="no-results">Nenhum v√≠deo em andamento. Explore o cat√°logo!</p>';
                return;
            }

            container.innerHTML = '';

            for (const progress of incompleteProgress.slice(0, 4)) {
                const video = await window.firestoreModule.getVideoById(progress.videoId);
                if (!video) continue;

                const card = window.uiModule.createVideoCard(video, (id) => {
                    window.location.href = `catalogo.html?v=${id}`;
                });
                container.appendChild(card);
            }
        }

        // Load watch history
        async function loadWatchHistory() {
            const container = document.getElementById('history-container');
            const progressList = await window.firestoreModule.getUserProgress();

            if (progressList.length === 0) {
                container.innerHTML = '<p class="no-results">Voc√™ ainda n√£o assistiu nenhum v√≠deo.</p>';
                return;
            }

            container.innerHTML = '';

            for (const progress of progressList.slice(0, 10)) {
                const video = await window.firestoreModule.getVideoById(progress.videoId);
                if (!video) continue;

                const percentage = video.duration > 0 ? (progress.watchTime / video.duration) * 100 : 0;
                const thumbnail = video.thumbnailUrl || 'https://via.placeholder.com/120x70/1a1a2e/00d9ff?text=' + encodeURIComponent(video.title.substring(0, 10));

                const item = document.createElement('div');
                item.className = 'history-item';
                item.onclick = () => window.location.href = `catalogo.html?v=${video.id}`;

                item.innerHTML = `
                    <div class="history-thumbnail" style="background-image: url('${thumbnail}');"></div>
                    <div class="history-info">
                        <div class="history-title">${video.title}</div>
                        <div class="history-progress-text">
                            ${window.uiModule.formatTime(progress.watchTime)} / ${window.uiModule.formatTime(video.duration)}
                            ${progress.completed ? ' - ‚úì Conclu√≠do' : ''}
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${Math.min(percentage, 100)}%;"></div>
                        </div>
                    </div>
                `;

                container.appendChild(item);
            }
        }

        // Handle profile update
        async function handleProfileUpdate(event) {
            event.preventDefault();

            const newDisplayName = document.getElementById('display-name').value.trim();

            if (!newDisplayName) {
                window.uiModule.showToast('Nome n√£o pode estar vazio', 'error');
                return;
            }

            window.uiModule.showLoading();

            const result = await window.authModule.updateUserProfile({
                displayName: newDisplayName
            });

            window.uiModule.hideLoading();

            if (result.success) {
                window.uiModule.showToast('Perfil atualizado com sucesso!', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                window.uiModule.showToast('Erro ao atualizar perfil: ' + result.error, 'error');
            }
        }

        // Handle password reset
        async function handlePasswordReset() {
            if (!confirm('Deseja redefinir sua senha? Um email ser√° enviado para ' + currentUser.email)) {
                return;
            }

            window.uiModule.showLoading();
            const result = await window.authModule.resetPassword(currentUser.email);
            window.uiModule.hideLoading();

            if (result.success) {
                window.uiModule.showToast('Email de redefini√ß√£o enviado!', 'success');
            } else {
                window.uiModule.showToast('Erro: ' + result.error, 'error');
            }
        }

        // Scroll helpers
        function scrollToProfile() {
            document.getElementById('profile-section').scrollIntoView({ behavior: 'smooth' });
        }

        function scrollToHistory() {
            document.getElementById('history-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Handle logout
        async function handleLogout(event) {
            event.preventDefault();
            const result = await window.authModule.logoutUser();
            if (result.success) {
                window.location.href = 'index.html';
            } else {
                window.uiModule.showToast('Erro ao sair', 'error');
            }
        }
    </script>

</body>

</html>