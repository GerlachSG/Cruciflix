<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CruciFlix - In√≠cio</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ============================================
           NETFLIX-STYLE DASHBOARD
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            transition: background 0.3s;
        }

        .header.scrolled {
            background: rgba(10,10,10,0.95);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: #00a79e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-menu {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-menu a {
            color: #ccc;
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.3s;
        }

        .nav-menu a:hover, .nav-menu a.active {
            color: #fff;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-btn, .notifications-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .search-btn:hover, .notifications-btn:hover {
            color: #00a79e;
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            background: none;
            border: none;
            color: #fff;
        }

        .profile-avatar {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            object-fit: cover;
        }

        .profile-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(20,20,20,0.95);
            border: 1px solid #333;
            border-radius: 4px;
            min-width: 200px;
            padding: 10px 0;
            display: none;
            margin-top: 10px;
        }

        .profile-menu.active {
            display: block;
        }

        .profile-menu a, .profile-menu button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            color: #ccc;
            text-decoration: none;
            font-size: 0.9rem;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.3s;
        }

        .profile-menu a:hover, .profile-menu button:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .profile-menu hr {
            border: none;
            border-top: 1px solid #333;
            margin: 8px 0;
        }

        /* Hero Section */
        .hero {
            height: 85vh;
            min-height: 600px;
            position: relative;
            display: flex;
            align-items: flex-end;
            padding: 0 40px 100px;
        }

        .hero-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center top;
            z-index: -1;
        }

        .hero-bg::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(0deg, #0a0a0a 0%, transparent 50%, rgba(0,0,0,0.3) 100%),
                        linear-gradient(90deg, rgba(0,0,0,0.8) 0%, transparent 50%);
        }

        .hero-content {
            max-width: 550px;
            z-index: 1;
        }

        .hero-logo {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.8);
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.8);
        }

        .hero-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .hero-meta span {
            color: #aaa;
        }

        .hero-match {
            color: #46d369;
            font-weight: 600;
        }

        .hero-rating {
            padding: 2px 8px;
            border: 1px solid #aaa;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .hero-description {
            font-size: 1.1rem;
            line-height: 1.5;
            color: #ddd;
            margin-bottom: 25px;
            text-shadow: 1px 1px 5px rgba(0,0,0,0.8);
        }

        .hero-tags {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .hero-tag {
            padding: 5px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #ccc;
        }

        .hero-actions {
            display: flex;
            gap: 12px;
        }

        .btn-play {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            color: #000;
            border: none;
            padding: 12px 28px;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-play:hover {
            background: rgba(255,255,255,0.8);
        }

        .btn-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(109,109,110,0.7);
            color: #fff;
            border: none;
            padding: 12px 28px;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-info:hover {
            background: rgba(109,109,110,0.5);
        }

        /* Content Rows */
        .content-section {
            padding: 0 40px;
            margin-top: -80px;
            position: relative;
            z-index: 10;
        }

        .row {
            margin-bottom: 40px;
        }

        .row-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .row-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #fff;
        }

        .row-see-all {
            color: #aaa;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .row-see-all:hover {
            color: #fff;
        }

        .row-slider {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding-bottom: 20px;
            scrollbar-width: none;
        }

        .row-slider::-webkit-scrollbar {
            display: none;
        }

        /* Content Card */
        .content-card {
            flex: 0 0 auto;
            width: 230px;
            cursor: pointer;
            transition: transform 0.3s, z-index 0.3s;
            position: relative;
        }

        .content-card:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .card-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 4px;
            object-fit: cover;
            background: #222;
        }

        .card-info {
            padding: 10px 0;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: #fff;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #888;
        }

        .card-match {
            color: #46d369;
        }

        /* Continue Watching Card */
        .continue-card {
            position: relative;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255,255,255,0.3);
        }

        .progress-fill {
            height: 100%;
            background: #00a79e;
        }

        /* Card Hover Preview (simplified) */
        .card-hover-preview {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            width: 320px;
            background: #181818;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 100;
        }

        .content-card:hover .card-hover-preview {
            opacity: 1;
            transform: translateX(-50%) scale(1);
            pointer-events: auto;
        }

        .preview-video {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 8px 8px 0 0;
            object-fit: cover;
            background: #000;
        }

        .preview-info {
            padding: 15px;
        }

        .preview-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .preview-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #fff;
            background: transparent;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .preview-btn.play {
            background: #fff;
            color: #000;
            border: none;
        }

        .preview-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .preview-meta {
            display: flex;
            gap: 10px;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .preview-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .preview-tag {
            font-size: 0.75rem;
            color: #aaa;
        }

        .preview-tag::after {
            content: '‚Ä¢';
            margin-left: 5px;
            color: #555;
        }

        .preview-tag:last-child::after {
            display: none;
        }

        /* Profile Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #181818;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .modal-header h2 {
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            max-height: calc(85vh - 140px);
            overflow-y: auto;
        }

        .avatar-gallery {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .avatar-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .avatar-option:hover {
            border-color: #fff;
        }

        .avatar-option.selected {
            border-color: #00a79e;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00a79e;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid #333;
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid #666;
            color: #fff;
            padding: 10px 25px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-save {
            background: #00a79e;
            border: none;
            color: #fff;
            padding: 10px 25px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Footer */
        .footer {
            padding: 50px 40px;
            color: #808080;
            font-size: 0.85rem;
        }

        .footer-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .footer-links a {
            color: #808080;
            text-decoration: none;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 10px 20px;
            }

            .nav-menu {
                display: none;
            }

            .hero {
                height: 70vh;
                min-height: 500px;
                padding: 0 20px 80px;
            }

            .hero-title {
                font-size: 2rem;
            }

            .hero-description {
                font-size: 0.95rem;
            }

            .content-section {
                padding: 0 20px;
            }

            .content-card {
                width: 160px;
            }

            .row-title {
                font-size: 1.1rem;
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 15px 25px;
            border-radius: 4px;
            z-index: 2000;
            display: none;
        }

        .toast.success {
            background: #46d369;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .no-content {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header" id="header">
        <a href="dashboard.html" class="logo" style="text-decoration: none;">
            <i class="fas fa-cross"></i>
            CruciFlix
        </a>

        <nav>
            <ul class="nav-menu">
                <li><a href="dashboard.html" class="active">In√≠cio</a></li>
                <li><a href="catalogo.html?filter=series">S√©ries</a></li>
                <li><a href="catalogo.html?filter=movies">Filmes</a></li>
                <li><a href="catalogo.html?filter=kids">Kids</a></li>
                <li><a href="catalogo.html#mylist">Minha Lista</a></li>
            </ul>
        </nav>

        <div class="header-right">
            <div class="search-container" id="search-container" style="display: none;">
                <input type="text" id="search-input" placeholder="T√≠tulos, pessoas, g√™neros" style="
                    background: rgba(0,0,0,0.75);
                    border: 1px solid #fff;
                    padding: 8px 15px;
                    color: #fff;
                    width: 250px;
                    border-radius: 4px;
                    font-size: 0.9rem;
                ">
            </div>
            <button class="search-btn" onclick="toggleSearch()">
                <i class="fas fa-search"></i>
            </button>
            <button class="notifications-btn">
                <i class="fas fa-bell"></i>
            </button>
            
            <div class="profile-dropdown">
                <button class="profile-btn" onclick="toggleProfileMenu()">
                    <img src="" alt="Perfil" class="profile-avatar" id="header-avatar">
                    <i class="fas fa-caret-down"></i>
                </button>
                <div class="profile-menu" id="profile-menu">
                    <a href="#" onclick="handleSwitchProfile(event)">
                        <i class="fas fa-exchange-alt"></i>
                        Trocar Perfil
                    </a>
                    <a href="#" onclick="handleManageProfile(event)">
                        <i class="fas fa-user-edit"></i>
                        Gerenciar Perfil
                    </a>
                    <hr>
                    <a href="#" id="admin-link" style="display: none;">
                        <i class="fas fa-cog"></i>
                        Painel Admin
                    </a>
                    <button onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair do CruciFlix
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="hero">
        <div class="hero-bg" id="hero-bg"></div>
        <div class="hero-content">
            <h1 class="hero-title" id="hero-title">Carregando...</h1>
            <div class="hero-meta">
                <span class="hero-match" id="hero-match">98% relevante</span>
                <span id="hero-year">2024</span>
                <span class="hero-rating" id="hero-rating">L</span>
                <span id="hero-duration"></span>
            </div>
            <p class="hero-description" id="hero-description">
                Carregando descri√ß√£o...
            </p>
            <div class="hero-tags" id="hero-tags"></div>
            <div class="hero-actions">
                <button class="btn-play" id="btn-play">
                    <i class="fas fa-play"></i>
                    Assistir
                </button>
                <button class="btn-info" id="btn-info">
                    <i class="fas fa-info-circle"></i>
                    Mais Informa√ß√µes
                </button>
            </div>
        </div>
    </section>

    <!-- Content Rows -->
    <main class="content-section">
        <!-- Continue Watching -->
        <section class="row" id="continue-row" style="display: none;">
            <div class="row-header">
                <h2 class="row-title">Continuar Assistindo</h2>
            </div>
            <div class="row-slider" id="continue-slider"></div>
        </section>

        <!-- My List -->
        <section class="row" id="mylist-row" style="display: none;">
            <div class="row-header">
                <h2 class="row-title">Minha Lista</h2>
                <a href="#" class="row-see-all">Ver tudo <i class="fas fa-chevron-right"></i></a>
            </div>
            <div class="row-slider" id="mylist-slider"></div>
        </section>

        <!-- Popular Movies -->
        <section class="row" id="movies-row">
            <div class="row-header">
                <h2 class="row-title">Filmes Populares</h2>
                <a href="catalogo.html?type=movie" class="row-see-all">Ver tudo <i class="fas fa-chevron-right"></i></a>
            </div>
            <div class="row-slider" id="movies-slider"></div>
        </section>

        <!-- Series -->
        <section class="row" id="series-row">
            <div class="row-header">
                <h2 class="row-title">S√©ries em Destaque</h2>
                <a href="catalogo.html?type=series" class="row-see-all">Ver tudo <i class="fas fa-chevron-right"></i></a>
            </div>
            <div class="row-slider" id="series-slider"></div>
        </section>

        <!-- Kids -->
        <section class="row" id="kids-row">
            <div class="row-header">
                <h2 class="row-title">Para as Crian√ßas</h2>
                <a href="catalogo.html?type=kids" class="row-see-all">Ver tudo <i class="fas fa-chevron-right"></i></a>
            </div>
            <div class="row-slider" id="kids-slider"></div>
        </section>

        <!-- Dynamic Tag Rows will be inserted here -->
        <div id="tag-rows"></div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-links">
            <a href="#">Perguntas frequentes</a>
            <a href="#">Central de Ajuda</a>
            <a href="#">Termos de Uso</a>
            <a href="#">Privacidade</a>
            <a href="#">Prefer√™ncias de Cookies</a>
            <a href="#">Informa√ß√µes Corporativas</a>
        </div>
        <p>¬© 2024 CruciFlix</p>
    </footer>

    <!-- Profile Modal -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Perfil</h2>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #aaa;">Escolha um avatar:</p>
                <div class="avatar-gallery" id="avatar-gallery"></div>
                
                <div class="form-group">
                    <label>Nome do Perfil</label>
                    <input type="text" id="profile-name-input" placeholder="Nome do perfil">
                </div>
                
                <div class="form-group">
                    <label>PIN de Bloqueio (4 d√≠gitos - opcional)</label>
                    <input type="password" id="profile-pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" pattern="[0-9]*" inputmode="numeric" style="width: 120px;">
                    <small style="color: #666; display: block; margin-top: 5px;">Usado para proteger este perfil</small>
                </div>
                
                <div class="form-group" style="display: flex; align-items: center; gap: 15px;">
                    <label style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                        <div class="toggle-switch" id="kids-toggle" onclick="toggleKidsMode()">
                            <div class="toggle-slider"></div>
                        </div>
                        <span>Perfil Kids</span>
                    </label>
                    <small style="color: #666;">Mostra apenas conte√∫do apropriado para crian√ßas</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeProfileModal()">Cancelar</button>
                <button class="btn-save" onclick="saveProfileChanges()">Salvar</button>
            </div>
        </div>
    </div>

    <style>
        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #444;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #00a79e;
        }
        .toggle-slider {
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        .toggle-switch.active .toggle-slider {
            left: 26px;
        }
    </style>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Kids PIN Modal -->
    <div class="modal" id="kids-pin-modal" style="display: none;">
        <div class="kids-pin-modal-content">
            <div class="kids-pin-modal-header">
                <div class="kids-pin-icon">üîí</div>
                <h2>Controle Parental</h2>
            </div>
            <p class="kids-pin-text">Digite o PIN do perfil Kids para continuar</p>
            
            <div class="kids-pin-input-group">
                <input type="password" class="kids-pin-digit" maxlength="1" data-index="0" inputmode="numeric">
                <input type="password" class="kids-pin-digit" maxlength="1" data-index="1" inputmode="numeric">
                <input type="password" class="kids-pin-digit" maxlength="1" data-index="2" inputmode="numeric">
                <input type="password" class="kids-pin-digit" maxlength="1" data-index="3" inputmode="numeric">
            </div>
            
            <p class="kids-pin-error hidden" id="kids-pin-error">PIN incorreto. Tente novamente.</p>
            
            <div class="kids-pin-actions">
                <button class="kids-pin-btn cancel" onclick="closeKidsPinModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <style>
        /* Kids PIN Modal Styles */
        #kids-pin-modal {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            animation: kidsPinFadeIn 0.3s ease;
        }
        @keyframes kidsPinFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes kidsPinSlideIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .kids-pin-modal-content {
            max-width: 400px;
            width: 92%;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255,255,255,0.1);
            padding: 0;
            overflow: hidden;
            animation: kidsPinSlideIn 0.4s ease;
        }
        .kids-pin-modal-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            padding: 28px 28px 24px;
            text-align: center;
        }
        .kids-pin-icon {
            width: 64px;
            height: 64px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 28px;
        }
        .kids-pin-modal-header h2 {
            margin: 0;
            color: #fff;
            font-size: 1.4rem;
            font-weight: 700;
        }
        .kids-pin-text {
            color: #a0a0a0;
            font-size: 0.95rem;
            text-align: center;
            padding: 24px 28px 0;
            margin: 0;
        }
        .kids-pin-input-group {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 24px 28px;
        }
        .kids-pin-digit {
            width: 56px;
            height: 64px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
        }
        .kids-pin-digit:focus {
            border-color: #00a79e;
            background: rgba(0, 167, 158, 0.1);
            box-shadow: 0 0 20px rgba(0, 167, 158, 0.3);
        }
        .kids-pin-digit.error {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            animation: shake 0.5s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .kids-pin-error {
            color: #ff6b6b;
            font-size: 0.9rem;
            text-align: center;
            margin: 0;
            padding: 0 28px 16px;
        }
        .kids-pin-error.hidden {
            display: none;
        }
        .kids-pin-actions {
            display: flex;
            justify-content: center;
            padding: 0 28px 28px;
        }
        .kids-pin-btn {
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        .kids-pin-btn.cancel {
            background: rgba(255,255,255,0.08);
            color: #aaa;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .kids-pin-btn.cancel:hover {
            background: rgba(255,255,255,0.12);
            color: #fff;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12"></script>

    <!-- App Scripts -->
    <script src="../scripts/app-core.js"></script>
    <script src="../scripts/app-catalog.js"></script>

    <script>
        // Global state (reuse `currentProfile` from `app-core.js`)
        let currentUser = null;
        let featuredContent = null;
        let selectedAvatar = null;
        let isKidsProfile = false; // global flag used across functions

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Check if email is verified
                if (!user.emailVerified) {
                    window.location.href = 'verify-email.html';
                    return;
                }
                
                currentUser = user;

                // Check profile
                currentProfile = window.authModule?.getCurrentProfile?.();
                if (!currentProfile) {
                    window.location.href = 'select-profile.html';
                    return;
                }

                // Determine kids profile and apply visual mode
                isKidsProfile = !!currentProfile?.isKids;
                document.body.classList.toggle('kids-mode', isKidsProfile);

                // Initialize UI
                initializeUI();
                await loadContent();

                // Check admin
                const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().role === 'admin') {
                    document.getElementById('admin-link').style.display = 'flex';
                    document.getElementById('admin-link').href = 'admin.html';
                }
            });

            // Header scroll effect
            window.addEventListener('scroll', () => {
                document.getElementById('header').classList.toggle('scrolled', window.scrollY > 50);
            });
        });

        function initializeUI() {
            // Set profile avatar
            const avatarImg = document.getElementById('header-avatar');
            avatarImg.src = currentProfile?.avatar || window.authModule?.AVATARS?.[0]?.url || 'https://api.dicebear.com/7.x/initials/svg?seed=SA&backgroundColor=8b0000';
            
            // Populate avatar gallery
            const gallery = document.getElementById('avatar-gallery');
            const avatars = window.authModule?.AVATARS || [];
            gallery.innerHTML = avatars.map(avatar => `
                <img src="${avatar.url}" class="avatar-option ${avatar.url === currentProfile?.avatar ? 'selected' : ''}" 
                     onclick="selectAvatar('${avatar.url}')" alt="${avatar.name}" title="${avatar.name}">
            `).join('');
            
            document.getElementById('profile-name-input').value = currentProfile.name || '';
            document.getElementById('profile-pin-input').value = currentProfile.pin || '';
            
            // Set kids toggle state
            const kidsToggle = document.getElementById('kids-toggle');
            if (currentProfile.isKids) {
                kidsToggle.classList.add('active');
            } else {
                kidsToggle.classList.remove('active');
            }
            
            selectedAvatar = currentProfile.avatar;
        }

        function toggleKidsMode() {
            const toggle = document.getElementById('kids-toggle');
            toggle.classList.toggle('active');
        }

        async function loadContent() {
            try {
                // Load all content
                const [movies, series, tags] = await Promise.all([
                    window.firestoreModule.getAllMovies(),
                    window.firestoreModule.getAllSeries(),
                    window.firestoreModule.getAllTags()
                ]);

                // Use global isKidsProfile flag set earlier
                function filterVisible(arr) {
                    if (!Array.isArray(arr)) return [];
                    return isKidsProfile ? arr.filter(c => c.isKidsSafe) : arr;
                }

                // Set hero (featured content)
                const allContent = [...filterVisible(movies), ...filterVisible(series)].filter(c => c.bannerUrl);
                if (allContent.length > 0) {
                    featuredContent = allContent[Math.floor(Math.random() * allContent.length)];
                    setHeroContent(featuredContent);
                } else if (movies.length > 0) {
                    featuredContent = movies[0];
                    setHeroContent(featuredContent);
                }

                // Load continue watching
                await loadContinueWatching();

                // Load my list
                await loadMyList();

                // Populate rows (apply kids filter when needed)
                const visibleMovies = filterVisible(movies);
                const visibleSeries = filterVisible(series);
                populateRow('movies-slider', visibleMovies);
                populateRow('series-slider', visibleSeries);
                
                // Kids content (still populate kids row if any kids content exists)
                const kidsContent = [...filterVisible(movies), ...filterVisible(series)].filter(c => c.isKidsSafe);
                if (kidsContent.length > 0) {
                    populateRow('kids-slider', kidsContent);
                    document.getElementById('kids-row').style.display = 'block';
                } else {
                    document.getElementById('kids-row').style.display = 'none';
                }

                // Dynamic tag rows
                const tagRows = document.getElementById('tag-rows');
                for (const tag of tags.slice(0, 5)) {
                    const tagContent = [...filterVisible(movies), ...filterVisible(series)].filter(c => 
                        c.tags && c.tags.includes(tag.name)
                    );
                    if (tagContent.length >= 3) {
                        const row = document.createElement('section');
                        row.className = 'row';
                        row.innerHTML = `
                            <div class="row-header">
                                <h2 class="row-title">${tag.name}</h2>
                                <a href="#" class="row-see-all">Ver tudo <i class="fas fa-chevron-right"></i></a>
                            </div>
                            <div class="row-slider" id="tag-${tag.id}-slider"></div>
                        `;
                        tagRows.appendChild(row);
                        populateRow(`tag-${tag.id}-slider`, tagContent);
                    }
                }

            } catch (error) {
                console.error('Error loading content:', error);
            }
        }
        // Normalize duration to minutes (prefer durationMinutes) and format for display
        function minutesFromContent(content) {
            if (!content) return null;
            if (content.durationMinutes !== undefined && content.durationMinutes !== null) return content.durationMinutes;
            if (content.duration !== undefined && content.duration !== null) {
                const v = Number(content.duration);
                if (isNaN(v)) return null;
                if (v > 500) return Math.floor(v / 60); // treat as seconds
                return Math.ceil(v);
            }
            return null;
        }

        function formatDurationMinutes(minutes) {
            if (minutes === undefined || minutes === null) return '';
            const h = Math.floor(minutes / 60);
            const m = Math.floor(minutes % 60);
            if (h === 0) return `${minutes} min`;
            return `${h}H${m.toString().padStart(2, '0')}`;
        }

        function setHeroContent(content) {
            document.getElementById('hero-bg').style.backgroundImage = `url('${content.bannerUrl || content.thumbnailUrl || ''}')`;
            document.getElementById('hero-title').textContent = content.title;
            document.getElementById('hero-year').textContent = content.year || '2024';
            const mins = minutesFromContent(content);
            document.getElementById('hero-duration').textContent = mins ? formatDurationMinutes(mins) : '';
            document.getElementById('hero-description').textContent = content.description || '';
            // Rating badge (normalize class without '+')
            const heroRatingEl = document.getElementById('hero-rating');
            const rawRating = content.rating || 'L';
            const displayRating = rawRating;
            const classRating = rawRating === 'L' ? 'L' : rawRating.toString().replace(/\+/g, '').replace(/\s+/g, '');
            heroRatingEl.textContent = displayRating;
            heroRatingEl.className = `hero-rating rating-${classRating}`;
            
            const tagsContainer = document.getElementById('hero-tags');
            tagsContainer.innerHTML = (content.tags || []).slice(0, 4).map(tag => 
                `<span class="hero-tag">${tag}</span>`
            ).join('');

            document.getElementById('btn-play').onclick = () => playContent(content);
            document.getElementById('btn-info').onclick = () => showInfo(content);
        }

        async function loadContinueWatching() {
            const progress = await window.firestoreModule.getUserProgress();
            if (progress && progress.length > 0) {
                document.getElementById('continue-row').style.display = 'block';
                const slider = document.getElementById('continue-slider');
                slider.innerHTML = '';
                
                for (const item of progress.slice(0, 10)) {
                    if (item.content) {
                        // If in kids profile, skip non-kids content
                        if (isKidsProfile && !item.content.isKidsSafe) continue;
                        const card = createContinueCard(item.content, item.watchTime, item.content.duration);
                        slider.appendChild(card);
                    }
                }
            }
        }

        async function loadMyList() {
            const watchlist = await window.firestoreModule.getWatchlist();
            if (watchlist && watchlist.length > 0) {
                document.getElementById('mylist-row').style.display = 'block';
                const visibleWatchlist = isKidsProfile ? watchlist.filter(item => item.isKidsSafe) : watchlist;
                populateRow('mylist-slider', visibleWatchlist);
            }
        }

        function populateRow(sliderId, content) {
            const slider = document.getElementById(sliderId);
            if (!slider) return;
            
            if (content.length === 0) {
                slider.innerHTML = '<p class="no-content">Nenhum conte√∫do dispon√≠vel</p>';
                return;
            }

            slider.innerHTML = content.map(item => createContentCard(item)).join('');
        }

        function createContentCard(item) {
            const thumbnail = item.thumbnailUrl || 'https://via.placeholder.com/230x130/222/fff?text=' + encodeURIComponent(item.title);
            const type = (item.type || '').toLowerCase() === 'series' ? 'S√©rie' : 'Filme';
            
            return `
                <div class="content-card" onclick="playContent(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <img src="${thumbnail}" alt="${item.title}" class="card-thumbnail">
                    <div class="card-info">
                        <div class="card-title">${item.title}</div>
                        <div class="card-meta">
                            <span class="card-match">98%</span>
                            <span>${item.year || '2024'}</span>
                            <span>${type}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function createContinueCard(item, watchTime, duration) {
            const card = document.createElement('div');
            card.className = 'content-card continue-card';
            card.onclick = () => playContent(item);
            
            const thumbnail = item.thumbnailUrl || 'https://via.placeholder.com/230x130';
            const progress = duration > 0 ? (watchTime / duration) * 100 : 0;
            
            card.innerHTML = `
                <div style="position: relative;">
                    <img src="${thumbnail}" alt="${item.title}" class="card-thumbnail">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
                <div class="card-info">
                    <div class="card-title">${item.title}</div>
                    <div class="card-meta">
                        <span>${formatTime(watchTime)} restantes</span>
                    </div>
                </div>
            `;
            
            return card;
        }

        function formatTime(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function playContent(content) {
            try {
                if (typeof content === 'string') {
                    content = JSON.parse(content);
                }

                // Normalize type
                const contentType = (content.type || '').toLowerCase();
                const type = contentType === 'series' ? 'series' : 'movie';

                // Fetch content metadata and user subscription
                const contentMeta = await window.firestoreModule.getContentById(content.id, type);
                const required = (contentMeta?.subscriptionLevel || contentMeta?.subscription || 'free').toString().toLowerCase();
                const ranks = { free: 0, basic: 1, premium: 2 };
                const userSub = await window.authModule.getUserSubscription();
                const userPlan = (userSub && userSub.plan) ? userSub.plan.toString().toLowerCase() : 'free';

                if ((ranks[userPlan] || 0) >= (ranks[required] || 0)) {
                    window.location.href = `player.html?type=${type}&id=${content.id}`;
                } else {
                    // Use global UI helper if available
                    if (window.uiModule && typeof window.uiModule.showUpgradeModal === 'function') {
                        window.uiModule.showUpgradeModal(contentMeta, required, userPlan);
                    } else {
                        alert(`Este conte√∫do requer o plano ${required.toUpperCase()}. Atualize seu plano para assistir.`);
                    }
                }
            } catch (err) {
                console.error('Erro ao reproduzir conte√∫do:', err);
                alert('Erro ao abrir player. Tente novamente.');
            }
        }

        function showInfo(content) {
            // For now, just play - could show a detail modal
            playContent(content);
        }

        // Profile menu
        function toggleProfileMenu() {
            document.getElementById('profile-menu').classList.toggle('active');
        }

        // Kids PIN protection for profile actions
        let kidsPinAction = null; // 'switchProfile' | 'manageProfile'

        function handleSwitchProfile(event) {
            event.preventDefault();
            document.getElementById('profile-menu').classList.remove('active');
            
            // Check if current profile is Kids
            const profile = window.authModule?.getCurrentProfile?.();
            if (profile && profile.isKids) {
                kidsPinAction = 'switchProfile';
                openKidsPinModal();
                return;
            }
            
            // Not a kids profile, go directly
            window.location.href = 'select-profile.html';
        }

        function handleManageProfile(event) {
            event.preventDefault();
            document.getElementById('profile-menu').classList.remove('active');
            
            // Check if current profile is Kids
            const profile = window.authModule?.getCurrentProfile?.();
            if (profile && profile.isKids) {
                kidsPinAction = 'manageProfile';
                openKidsPinModal();
                return;
            }
            
            // Not a kids profile, open modal directly
            openProfileModal();
        }

        function openKidsPinModal() {
            const modal = document.getElementById('kids-pin-modal');
            modal.style.display = 'flex';
            
            // Clear inputs
            document.querySelectorAll('.kids-pin-digit').forEach(input => {
                input.value = '';
                input.classList.remove('error');
            });
            document.getElementById('kids-pin-error').classList.add('hidden');
            
            // Focus first input
            setTimeout(() => {
                document.querySelector('.kids-pin-digit[data-index="0"]').focus();
            }, 100);
        }

        function closeKidsPinModal() {
            document.getElementById('kids-pin-modal').style.display = 'none';
            // Don't reset kidsPinAction here - it's needed after closing
        }

        // Setup PIN input events immediately (not waiting for DOMContentLoaded)
        function setupKidsPinInputs() {
            document.querySelectorAll('.kids-pin-digit').forEach(input => {
                input.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    
                    // Only allow numbers
                    this.value = this.value.replace(/[^0-9]/g, '');
                    
                    if (this.value.length === 1) {
                        // Move to next input
                        if (index < 3) {
                            document.querySelector(`.kids-pin-digit[data-index="${index + 1}"]`).focus();
                        } else {
                            // All digits entered, verify PIN
                            verifyKidsPin();
                        }
                    }
                });

                input.addEventListener('keydown', function(e) {
                    const index = parseInt(this.dataset.index);
                    
                    if (e.key === 'Backspace' && !this.value && index > 0) {
                        document.querySelector(`.kids-pin-digit[data-index="${index - 1}"]`).focus();
                    }
                });

                // Handle paste
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const paste = (e.clipboardData || window.clipboardData).getData('text');
                    const digits = paste.replace(/[^0-9]/g, '').slice(0, 4);
                    
                    document.querySelectorAll('.kids-pin-digit').forEach((inp, i) => {
                        inp.value = digits[i] || '';
                    });
                    
                    if (digits.length === 4) {
                        verifyKidsPin();
                    } else if (digits.length > 0) {
                        document.querySelector(`.kids-pin-digit[data-index="${Math.min(digits.length, 3)}"]`).focus();
                    }
                });
            });
        }
        
        // Run setup immediately
        setupKidsPinInputs();

        async function verifyKidsPin() {
            const digits = Array.from(document.querySelectorAll('.kids-pin-digit')).map(i => i.value).join('');
            if (digits.length !== 4) return;

            const profile = window.authModule?.getCurrentProfile?.();
            if (!profile) return;

            const isValid = await window.authModule.verifyKidsPin(profile.id, digits);
            
            if (isValid) {
                // Save action before closing (closeKidsPinModal doesn't reset it anymore)
                const actionToExecute = kidsPinAction;
                closeKidsPinModal();
                kidsPinAction = null; // Reset after saving
                
                // Execute the action
                if (actionToExecute === 'switchProfile') {
                    window.location.href = 'select-profile.html';
                } else if (actionToExecute === 'manageProfile') {
                    openProfileModal();
                }
            } else {
                // Show error
                document.getElementById('kids-pin-error').classList.remove('hidden');
                document.querySelectorAll('.kids-pin-digit').forEach(input => {
                    input.value = '';
                    input.classList.add('error');
                });
                document.querySelector('.kids-pin-digit[data-index="0"]').focus();
                
                setTimeout(() => {
                    document.querySelectorAll('.kids-pin-digit').forEach(input => {
                        input.classList.remove('error');
                    });
                }, 500);
            }
        }

        // Close modal on overlay click
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('kids-pin-modal');
            if (e.target === modal) {
                closeKidsPinModal();
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.profile-dropdown')) {
                document.getElementById('profile-menu').classList.remove('active');
            }
        });

        // Profile modal
        function openProfileModal() {
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('profile-menu').classList.remove('active');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        function selectAvatar(avatar) {
            selectedAvatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        async function saveProfileChanges() {
            const newName = document.getElementById('profile-name-input').value.trim();
            if (!newName) {
                showToast('Nome n√£o pode estar vazio', 'error');
                return;
            }

            const newPin = document.getElementById('profile-pin-input').value.trim();
            if (newPin && (newPin.length !== 4 || !/^\d{4}$/.test(newPin))) {
                showToast('PIN deve ter 4 d√≠gitos num√©ricos', 'error');
                return;
            }

            const isKids = document.getElementById('kids-toggle').classList.contains('active');

            const updates = { 
                name: newName,
                pin: newPin || '',
                isKids: isKids
            };
            if (selectedAvatar) updates.avatar = selectedAvatar;

            const result = await window.authModule.updateProfile(currentProfile.id, updates);
            
            if (result.success) {
                currentProfile = { ...currentProfile, ...updates };
                sessionStorage.setItem('currentProfile', JSON.stringify(currentProfile));
                document.getElementById('header-avatar').src = currentProfile.avatar;
                closeProfileModal();
                showToast('Perfil atualizado!', 'success');
            } else {
                showToast('Erro ao salvar: ' + result.error, 'error');
            }
        }

        function handleLogout() {
            firebase.auth().signOut().then(() => {
                sessionStorage.removeItem('currentProfile');
                window.location.href = 'index.html';
            });
        }

        function toggleSearch() {
            const container = document.getElementById('search-container');
            const input = document.getElementById('search-input');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                input.focus();
            } else {
                if (input.value.trim()) {
                    // Redirect to catalog with search query
                    window.location.href = `catalogo.html?search=${encodeURIComponent(input.value.trim())}`;
                } else {
                    container.style.display = 'none';
                }
            }
        }

        // Handle Enter key on search input
        document.getElementById('search-input')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                window.location.href = `catalogo.html?search=${encodeURIComponent(this.value.trim())}`;
            }
        });

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast active ' + type;
            setTimeout(() => toast.classList.remove('active'), 3000);
        }
    </script>
</body>
</html>
