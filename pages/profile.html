<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Meu Perfil - Cruciflix">
    <title>Perfil - Cruciflix</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@600;700;800&display=swap"
        rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/responsive.css">

    <style>
        .profile-page {
            padding-top: 70px;
            min-height: 100vh;
        }

        .profile-header {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(212, 175, 55, 0.3));
            padding: var(--spacing-3xl);
            margin-bottom: var(--spacing-2xl);
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-xl);
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-4xl);
            font-weight: 700;
            box-shadow: var(--shadow-lg);
        }

        .profile-details h1 {
            margin-bottom: var(--spacing-sm);
        }

        .profile-email {
            color: var(--color-text-secondary);
            font-size: var(--font-size-lg);
        }

        .profile-section {
            background: var(--color-bg-card);
            padding: var(--spacing-2xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
        }

        .profile-section h2 {
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-primary);
        }

        .history-grid {
            display: grid;
            gap: var(--spacing-md);
        }

        .history-item {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
            transition: all var(--transition-normal);
        }

        .history-item:hover {
            background: var(--color-bg-medium);
            transform: translateX(4px);
        }

        .history-thumbnail {
            width: 120px;
            height: 70px;
            border-radius: var(--radius-sm);
            background-size: cover;
            background-position: center;
            background-color: var(--color-bg-dark);
            flex-shrink: 0;
        }

        .history-info {
            flex: 1;
        }

        .history-title {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--color-text-primary);
        }

        .history-progress {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            margin-bottom: var(--spacing-xs);
        }

        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: var(--color-bg-dark);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: var(--radius-full);
        }
    </style>
</head>

<body>

    <!-- Header Navigation -->
    <header class="main-header">
        <div class="container">
            <nav class="nav-container">
                <div class="logo" onclick="window.location.href='dashboard.html'" style="cursor: pointer;">
                    Cruci<span class="accent">flix</span>
                </div>

                <div class="user-menu">
                    <div class="user-menu-btn" id="user-menu-btn">
                        <div class="user-avatar" id="user-avatar">U</div>
                    </div>
                    <div class="user-menu-dropdown" id="user-menu-dropdown">
                        <a href="dashboard.html">Catálogo</a>
                        <a href="kids.html">Área Kids</a>
                        <a href="#" onclick="handleLogout(event)">Sair</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="profile-page">

        <div class="profile-header">
            <div class="container">
                <div class="profile-info">
                    <div class="profile-avatar-large" id="profile-avatar-large">U</div>
                    <div class="profile-details">
                        <h1 id="profile-name">Carregando...</h1>
                        <p class="profile-email" id="profile-email"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">

            <!-- Watch History -->
            <section class="profile-section">
                <h2>Histórico de Visualização</h2>
                <div class="history-grid" id="history-container">
                    <!-- History loaded dynamically -->
                </div>
            </section>

            <!-- Account Settings -->
            <section class="profile-section">
                <h2>Configurações da Conta</h2>

                <form id="profile-form" onsubmit="handleProfileUpdate(event)">
                    <div class="form-group">
                        <label class="form-label">Nome de Exibição</label>
                        <input type="text" id="display-name" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="email" class="form-input" disabled>
                        <small style="color: var(--color-text-muted);">O email não pode ser alterado</small>
                    </div>

                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </form>
            </section>

            <!-- Danger Zone -->
            <section class="profile-section">
                <h2 style="color: var(--color-error);">Zona de Perigo</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-lg);">
                    Ações irreversíveis que afetam sua conta.
                </p>
                <button class="btn btn-ghost" style="border-color: var(--color-error); color: var(--color-error);"
                    onclick="handlePasswordReset()">
                    Redefinir Senha
                </button>
            </section>

        </div>

    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- App Scripts -->
    <script src="../scripts/firebase-config.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/firestore.js"></script>
    <script src="../scripts/ui.js"></script>

    <script>
        let currentUser = null;

        // Protect page - require authentication
        window.authModule.onAuthStateChanged(async (authState) => {
            if (!authState.loggedIn) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = authState.user;

            // Update profile info
            const displayName = currentUser.displayName || currentUser.email;
            const initials = displayName.charAt(0).toUpperCase();

            document.getElementById('profile-name').textContent = displayName;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-avatar-large').textContent = initials;
            document.getElementById('user-avatar').textContent = initials;

            // Populate form
            document.getElementById('display-name').value = currentUser.displayName || '';
            document.getElementById('email').value = currentUser.email;

            // Load watch history
            loadWatchHistory();
        });

        // Load watch history
        async function loadWatchHistory() {
            window.uiModule.showLoading();

            const progressList = await window.firestoreModule.getUserProgress();
            const container = document.getElementById('history-container');
            container.innerHTML = '';

            if (progressList.length === 0) {
                container.innerHTML = '<p class="no-results">Você ainda não assistiu nenhum vídeo.</p>';
                window.uiModule.hideLoading();
                return;
            }

            // Fetch video details for each progress entry
            for (const progress of progressList) {
                const video = await window.firestoreModule.getVideoById(progress.videoId);

                if (!video) continue;

                const percentage = video.duration > 0 ? (progress.watchTime / video.duration) * 100 : 0;
                const thumbnail = video.thumbnailUrl || 'https://via.placeholder.com/120x70/1a1a2e/00d9ff?text=' + encodeURIComponent(video.title.substring(0, 10));

                const item = document.createElement('div');
                item.className = 'history-item';
                item.onclick = () => window.location.href = `player.html?v=${video.id}`;
                item.style.cursor = 'pointer';

                item.innerHTML = `
        <div class="history-thumbnail" style="background-image: url('${thumbnail}');"></div>
        <div class="history-info">
          <div class="history-title">${video.title}</div>
          <div class="history-progress">
            ${window.uiModule.formatTime(progress.watchTime)} / ${window.uiModule.formatTime(video.duration)}
            ${progress.completed ? ' - ✓ Concluído' : ''}
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: ${Math.min(percentage, 100)}%;"></div>
          </div>
        </div>
      `;

                container.appendChild(item);
            }

            window.uiModule.hideLoading();
        }

        // Handle profile update
        async function handleProfileUpdate(event) {
            event.preventDefault();

            const newDisplayName = document.getElementById('display-name').value.trim();

            if (!newDisplayName) {
                window.uiModule.showToast('Nome não pode estar vazio', 'error');
                return;
            }

            window.uiModule.showLoading();

            const result = await window.authModule.updateUserProfile({
                displayName: newDisplayName
            });

            window.uiModule.hideLoading();

            if (result.success) {
                window.uiModule.showToast('Perfil atualizado com sucesso!', 'success');
                // Reload page to show updated info
                setTimeout(() => window.location.reload(), 1500);
            } else {
                window.uiModule.showToast('Erro ao atualizar perfil: ' + result.error, 'error');
            }
        }

        // Handle password reset
        async function handlePasswordReset() {
            if (!confirm('Deseja realmente redefinir sua senha? Um email será enviado para ' + currentUser.email)) {
                return;
            }

            window.uiModule.showLoading();

            const result = await window.authModule.resetPassword(currentUser.email);

            window.uiModule.hideLoading();

            if (result.success) {
                window.uiModule.showToast('Email de redefinição enviado!', 'success');
            } else {
                window.uiModule.showToast('Erro: ' + result.error, 'error');
            }
        }

        // Handle logout
        async function handleLogout(event) {
            event.preventDefault();
            const result = await window.authModule.logoutUser();
            if (result.success) {
                window.location.href = 'index.html';
            }
        }
    </script>

</body>

</html>