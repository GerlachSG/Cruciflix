<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Catálogo Cruciflix - Explore nosso acervo de filmes, séries e documentários católicos">
    <title>Catálogo - Cruciflix</title>
    <link rel="icon" href="data:,">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Base Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Autocomplete dark theme styling */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1a1a1a inset !important;
            -webkit-text-fill-color: #fff !important;
            caret-color: #fff !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        /* Header - Same as Dashboard */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            transition: background 0.3s;
        }

        .header.scrolled {
            background: rgba(10,10,10,0.95);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: #00a89d;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-menu {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-menu a {
            color: #ccc;
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.3s;
        }

        .nav-menu a:hover, .nav-menu a.active {
            color: #fff;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            background: none;
            border: none;
            color: #fff;
        }

        .profile-avatar {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            object-fit: cover;
        }

        .search-btn, .notifications-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .search-btn:hover, .notifications-btn:hover {
            color: #00a89d;
        }

        .header-search-container {
            display: none;
        }

        .header-search-container.active {
            display: block;
        }

        .header-search-container input {
            background: rgba(0,0,0,0.75);
            border: 1px solid #fff;
            padding: 8px 15px;
            color: #fff;
            width: 250px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .header-search-container input:focus {
            outline: none;
        }

        .profile-menu a, .profile-menu button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            color: #ccc;
            text-decoration: none;
            font-size: 0.9rem;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.3s;
        }

        .profile-menu hr {
            border: none;
            border-top: 1px solid #333;
            margin: 8px 0;
        }

        .profile-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(20,20,20,0.95);
            border: 1px solid #333;
            border-radius: 4px;
            min-width: 200px;
            padding: 10px 0;
            display: none;
            margin-top: 10px;
        }

        .profile-menu.active {
            display: block;
        }

        .profile-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            color: #ccc;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .profile-menu a:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        /* Catalog Page */
        .catalog-page {
            padding-top: 80px;
            min-height: 100vh;
        }

        /* Search Section */
        .search-section {
            padding: 30px 40px;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
        }

        .search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i {
            color: #00a89d;
        }

        /* Search Bar */
        .search-bar {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .search-bar input:focus {
            outline: none;
            background: rgba(255,255,255,0.15);
            border-color: #00a89d;
        }

        .search-bar input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .search-bar i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.5);
        }

        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .search-clear.visible {
            display: flex;
        }

        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            color: #ccc;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-btn:hover {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }

        .filter-btn.active {
            background: #00a89d;
            border-color: #00a89d;
            color: #fff;
        }

        .filter-btn .count {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* Tags Section */
        .tags-section {
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tags-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tags-header h3 {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .clear-tags {
            background: none;
            border: none;
            color: #00a89d;
            font-size: 0.85rem;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .clear-tags:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .tags-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tag-chip {
            padding: 8px 16px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tag-chip:hover {
            background: rgba(255,255,255,0.12);
            color: #fff;
        }

        .tag-chip.active {
            background: #00a89d;
            border-color: #00a89d;
            color: #fff;
        }

        /* Content Section */
        .content-section {
            padding: 30px 40px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .results-count {
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
        }

        .results-count strong {
            color: #fff;
        }

        .sort-select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            color: #fff;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .sort-select option {
            background: #1a1a1a;
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        @media (min-width: 1200px) {
            .content-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        /* Content Card */
        .content-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            aspect-ratio: 2/3;
            background: #1a1a1a;
        }

        .content-card:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .content-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .content-card:hover img {
            transform: scale(1.1);
        }

        .card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.95));
            padding: 60px 12px 12px;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .content-card:hover .card-overlay {
            transform: translateY(0);
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            display: flex;
            gap: 8px;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
        }

        .card-type {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 8px;
            background: #00a89d;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .card-type.series {
            background: #6366f1;
        }

        .card-rating {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .card-play {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 50px;
            height: 50px;
            background: #00a89d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .content-card:hover .card-play {
            transform: translate(-50%, -50%) scale(1);
        }

        .card-play i {
            font-size: 1.2rem;
            margin-left: 3px;
        }

        .card-kids {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 4px 8px;
            background: #22c55e;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255,255,255,0.5);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: rgba(255,255,255,0.2);
        }

        .empty-state h3 {
            font-size: 1.3rem;
            color: #fff;
            margin-bottom: 10px;
        }

        .empty-state p {
            max-width: 400px;
            margin: 0 auto 20px;
        }

        .empty-state .btn {
            padding: 12px 25px;
            background: #00a89d;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .empty-state .btn:hover {
            background: #008f85;
        }

        /* Loading Skeleton */
        .skeleton-card {
            aspect-ratio: 2/3;
            background: linear-gradient(90deg, #1a1a1a 25%, #252525 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }

            .search-section, .tags-section, .content-section {
                padding-left: 20px;
                padding-right: 20px;
            }

            .search-header {
                flex-direction: column;
                align-items: stretch;
            }

            .page-title {
                font-size: 1.5rem;
                justify-content: center;
            }

            .search-bar {
                max-width: 100%;
            }

            .filter-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }

            .content-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .card-overlay {
                transform: translateY(0);
                background: linear-gradient(transparent 40%, rgba(0,0,0,0.9));
            }

            .card-play {
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #181818;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .modal-header h2 {
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            max-height: calc(85vh - 140px);
            overflow-y: auto;
        }

        .avatar-gallery {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .avatar-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .avatar-option:hover {
            border-color: #fff;
        }

        .avatar-option.selected {
            border-color: #00a89d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00a89d;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #333;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel, .btn-save {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid #666;
            color: #fff;
        }

        .btn-cancel:hover {
            border-color: #fff;
        }

        .btn-save {
            background: #00a89d;
            color: #fff;
        }

        .btn-save:hover {
            background: #008f85;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #444;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #00a89d;
        }

        .toggle-slider {
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            left: 26px;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="header" id="header">
        <a href="dashboard.html" class="logo" style="text-decoration: none;">
            <i class="fas fa-cross"></i>
            CruciFlix
        </a>

        <nav>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Início</a></li>
                <li><a href="catalogo.html?filter=series">Séries</a></li>
                <li><a href="catalogo.html?filter=movies">Filmes</a></li>
                <li><a href="catalogo.html?filter=kids">Kids</a></li>
                <li><a href="catalogo.html#mylist">Minha Lista</a></li>
            </ul>
        </nav>

        <div class="header-right">
            <div class="header-search-container" id="header-search-container">
                <input type="text" id="header-search-input" placeholder="Títulos, pessoas, gêneros" onkeyup="handleHeaderSearch(event)" autocomplete="off" readonly>
            </div>
            <button class="search-btn" onclick="toggleHeaderSearch()">
                <i class="fas fa-search"></i>
            </button>
            <button class="notifications-btn">
                <i class="fas fa-bell"></i>
            </button>
            
            <div class="profile-dropdown">
                <button class="profile-btn" onclick="toggleProfileMenu()">
                    <img src="" alt="Perfil" class="profile-avatar" id="header-avatar">
                    <i class="fas fa-caret-down"></i>
                </button>
                <div class="profile-menu" id="profile-menu">
                    <a href="select-profile.html">
                        <i class="fas fa-exchange-alt"></i>
                        Trocar Perfil
                    </a>
                    <a href="#" onclick="openProfileModal()">
                        <i class="fas fa-user-edit"></i>
                        Gerenciar Perfil
                    </a>
                    <hr>
                    <a href="admin.html" id="admin-link" style="display: none;">
                        <i class="fas fa-cog"></i>
                        Painel Admin
                    </a>
                    <button onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair do CruciFlix
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="catalog-page">
        <!-- Search Section -->
        <section class="search-section">
            <div class="search-header">
                <h1 class="page-title">
                    <i class="fas fa-film"></i>
                    Catálogo
                </h1>

                <!-- Search Bar -->
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Buscar filmes, séries..." autocomplete="off" readonly>
                    <button class="search-clear" id="search-clear" onclick="clearSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Filter Buttons -->
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all" onclick="setTypeFilter('all')">
                        <i class="fas fa-th"></i>
                        Todos
                        <span class="count" id="count-all">0</span>
                    </button>
                    <button class="filter-btn" data-filter="movie" onclick="setTypeFilter('movie')">
                        <i class="fas fa-film"></i>
                        Filmes
                        <span class="count" id="count-movies">0</span>
                    </button>
                    <button class="filter-btn" data-filter="series" onclick="setTypeFilter('series')">
                        <i class="fas fa-tv"></i>
                        Séries
                        <span class="count" id="count-series">0</span>
                    </button>
                    <button class="filter-btn" data-filter="kids" onclick="setTypeFilter('kids')">
                        <i class="fas fa-child"></i>
                        Kids
                        <span class="count" id="count-kids">0</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Tags Section -->
        <section class="tags-section">
            <div class="tags-header">
                <h3>Filtrar por Tags</h3>
                <button class="clear-tags" id="clear-tags-btn" onclick="clearTagFilters()" disabled>
                    Limpar tags
                </button>
            </div>
            <div class="tags-list" id="tag-filters">
                <!-- Tags loaded dynamically -->
            </div>
        </section>

        <!-- Content Section -->
        <section class="content-section">
            <div class="results-header">
                <span class="results-count" id="results-count">
                    Mostrando <strong>0</strong> resultados
                </span>
                <select class="sort-select" id="sort-select" onchange="handleSort()">
                    <option value="recent">Mais recentes</option>
                    <option value="title">Título A-Z</option>
                    <option value="year">Ano</option>
                    <option value="views">Mais vistos</option>
                </select>
            </div>

            <!-- Content Grid -->
            <div class="content-grid" id="content-grid">
                <!-- Content loaded dynamically -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="empty-state" style="display: none;">
                <i class="fas fa-film"></i>
                <h3>Nenhum conteúdo encontrado</h3>
                <p>Tente ajustar os filtros ou fazer uma busca diferente.</p>
                <button class="btn" onclick="resetAllFilters()">Limpar filtros</button>
            </div>
        </section>
    </main>

    <!-- Profile Modal -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Perfil</h2>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #aaa;">Escolha um avatar:</p>
                <div class="avatar-gallery" id="avatar-gallery"></div>
                
                <div class="form-group">
                    <label>Nome do Perfil</label>
                    <input type="text" id="profile-name-input" placeholder="Nome do perfil">
                </div>
                
                <div class="form-group">
                    <label>PIN de Bloqueio (4 dígitos - opcional)</label>
                    <input type="password" id="profile-pin-input" placeholder="••••" maxlength="4" pattern="[0-9]*" inputmode="numeric" style="width: 120px;">
                    <small style="color: #666; display: block; margin-top: 5px;">Usado para proteger este perfil</small>
                </div>
                
                <div class="form-group" style="display: flex; align-items: center; gap: 15px;">
                    <label style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                        <div class="toggle-switch" id="kids-toggle" onclick="toggleKidsMode()">
                            <div class="toggle-slider"></div>
                        </div>
                        <span>Perfil Kids</span>
                    </label>
                    <small style="color: #666;">Mostra apenas conteúdo apropriado para crianças</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeProfileModal()">Cancelar</button>
                <button class="btn-save" onclick="saveProfileChanges()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- App Scripts -->
    <script src="../scripts/app-core.js"></script>
    <script src="../scripts/app-catalog.js"></script>

    <script>
        // Disable autocomplete by removing readonly after page load
        setTimeout(() => {
            document.getElementById('search-input')?.removeAttribute('readonly');
            document.getElementById('header-search-input')?.removeAttribute('readonly');
        }, 1000);

        // State
        let allContent = [];
        let filteredContent = [];
        let currentTypeFilter = 'all';
        let pageSelectedTags = [];
        let searchTerm = '';
        let allTags = [];

        // Initialize page
        window.authModule.onAuthStateChanged(async (authState) => {
            if (!authState.loggedIn) {
                window.location.href = 'index.html';
                return;
            }

            // Check if email is verified
            const user = firebase.auth().currentUser;
            if (user && !user.emailVerified) {
                window.location.href = 'verify-email.html';
                return;
            }

            // Load profile avatar
            loadProfileAvatar();

            // Show admin link if admin
            if (authState.isAdmin) {
                document.getElementById('admin-link').style.display = 'flex';
            }

            // Check URL for filters
            const urlParams = new URLSearchParams(window.location.search);
            const urlType = urlParams.get('type');
            const urlSearch = urlParams.get('q');
            
            if (urlType) {
                currentTypeFilter = urlType;
                updateTypeFilterButtons();
            }
            
            if (urlSearch) {
                searchTerm = urlSearch;
                document.getElementById('search-input').value = urlSearch;
                document.getElementById('search-clear').classList.add('visible');
            }

            // Load content
            await loadAllContent();
            await loadTags();
        });

        // Load profile avatar from sessionStorage (matching dashboard)
        function loadProfileAvatar() {
            const profileData = sessionStorage.getItem('currentProfile');
            const avatarImg = document.getElementById('header-avatar');
            
            if (profileData) {
                const profile = JSON.parse(profileData);
                avatarImg.src = profile.avatar || (window.authModule?.AVATARS?.[0]?.url || 'https://api.dicebear.com/7.x/initials/svg?seed=SA&backgroundColor=8b0000');
            } else {
                avatarImg.src = window.authModule?.AVATARS?.[0]?.url || 'https://api.dicebear.com/7.x/initials/svg?seed=SA&backgroundColor=8b0000';
            }
        }

        // Load all content (movies + series)
        async function loadAllContent() {
            showLoadingSkeleton();
            
            try {
                const [movies, series] = await Promise.all([
                    getAllMovies(),
                    getAllSeries()
                ]);

                allContent = [...movies, ...series];
                
                // Update counts
                updateCounts();
                
                // Apply filters
                applyFilters();
            } catch (error) {
                console.error('Error loading content:', error);
                showEmptyState();
            }
        }

        // Load tags
        async function loadTags() {
            try {
                allTags = await getAllTags();
                renderTagFilters();
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        }

        // Render tag filter chips
        function renderTagFilters() {
            const container = document.getElementById('tag-filters');
            container.innerHTML = '';

            allTags.forEach(tag => {
                const chip = document.createElement('button');
                chip.className = 'tag-chip';
                chip.textContent = tag.name;
                chip.dataset.tagId = tag.id;
                chip.onclick = () => toggleTag(tag.name, chip);
                container.appendChild(chip);
            });
        }

        // Toggle tag selection
        function toggleTag(tagName, element) {
            if (pageSelectedTags.includes(tagName)) {
                pageSelectedTags = pageSelectedTags.filter(t => t !== tagName);
                element.classList.remove('active');
            } else {
                pageSelectedTags.push(tagName);
                element.classList.add('active');
            }
            
            document.getElementById('clear-tags-btn').disabled = pageSelectedTags.length === 0;
            applyFilters();
        }

        // Clear tag filters
        function clearTagFilters() {
            pageSelectedTags = [];
            document.querySelectorAll('.tag-chip').forEach(chip => chip.classList.remove('active'));
            document.getElementById('clear-tags-btn').disabled = true;
            applyFilters();
        }

        // Set type filter
        function setTypeFilter(filter) {
            currentTypeFilter = filter;
            updateTypeFilterButtons();
            applyFilters();
            
            // Update URL
            const url = new URL(window.location);
            if (filter === 'all') {
                url.searchParams.delete('type');
            } else {
                url.searchParams.set('type', filter);
            }
            history.pushState({}, '', url);
        }

        // Update type filter buttons
        function updateTypeFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === currentTypeFilter);
            });
        }

        // Update counts
        function updateCounts() {
            const movies = allContent.filter(c => c.type === 'movie');
            const series = allContent.filter(c => c.type === 'series');
            const kids = allContent.filter(c => c.isKidsSafe);

            document.getElementById('count-all').textContent = allContent.length;
            document.getElementById('count-movies').textContent = movies.length;
            document.getElementById('count-series').textContent = series.length;
            document.getElementById('count-kids').textContent = kids.length;
        }

        // Apply all filters
        function applyFilters() {
            let result = [...allContent];

            // Type filter
            if (currentTypeFilter === 'movie') {
                result = result.filter(c => c.type === 'movie');
            } else if (currentTypeFilter === 'series') {
                result = result.filter(c => c.type === 'series');
            } else if (currentTypeFilter === 'kids') {
                result = result.filter(c => c.isKidsSafe);
            }

            // Tag filter
            if (pageSelectedTags.length > 0) {
                result = result.filter(c => 
                    c.tags && pageSelectedTags.some(tag => c.tags.includes(tag))
                );
            }

            // Search filter
            if (searchTerm.trim()) {
                const term = searchTerm.toLowerCase();
                result = result.filter(c =>
                    c.title.toLowerCase().includes(term) ||
                    (c.description && c.description.toLowerCase().includes(term)) ||
                    (c.tags && c.tags.some(t => t.toLowerCase().includes(term)))
                );
            }

            // Sort
            result = sortContent(result);

            filteredContent = result;
            renderContent();
        }

        // Sort content
        function sortContent(content) {
            const sortBy = document.getElementById('sort-select').value;

            return [...content].sort((a, b) => {
                switch (sortBy) {
                    case 'recent':
                        return (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0);
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'year':
                        return (b.year || 0) - (a.year || 0);
                    case 'views':
                        return (b.viewCount || 0) - (a.viewCount || 0);
                    default:
                        return 0;
                }
            });
        }

        // Handle sort change
        function handleSort() {
            applyFilters();
        }

        // Render content grid
        function renderContent() {
            const container = document.getElementById('content-grid');
            const emptyState = document.getElementById('empty-state');
            
            // Update results count
            document.getElementById('results-count').innerHTML = 
                `Mostrando <strong>${filteredContent.length}</strong> resultados`;

            if (filteredContent.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = filteredContent.map(item => createContentCard(item)).join('');
        }

        // Create content card HTML
        function createContentCard(item) {
            const thumbnail = item.thumbnailUrl || 'https://via.placeholder.com/300x450/1a1a1a/666?text=Sem+Imagem';
            const isMovie = item.type === 'movie';
            const typeLabel = isMovie ? 'Filme' : 'Série';
            const typeClass = isMovie ? '' : 'series';
            
            return `
                <div class="content-card" onclick="openContent('${item.id}', '${item.type}')">
                    <img src="${thumbnail}" alt="${item.title}" loading="lazy">
                    <span class="card-type ${typeClass}">${typeLabel}</span>
                    ${item.rating ? `<span class="card-rating">${item.rating}</span>` : ''}
                    ${item.isKidsSafe ? `<span class="card-kids">Kids</span>` : ''}
                    <div class="card-play">
                        <i class="fas fa-play"></i>
                    </div>
                    <div class="card-overlay">
                        <h3 class="card-title">${item.title}</h3>
                        <div class="card-meta">
                            <span>${item.year || 'N/A'}</span>
                            ${item.duration ? `<span>${formatDuration(item.duration)}</span>` : ''}
                            ${!isMovie && item.totalSeasons ? `<span>${item.totalSeasons} temp.</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Format duration
        function formatDuration(minutes) {
            if (!minutes) return '';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return h > 0 ? `${h}h${m}min` : `${m}min`;
        }

        // Open content (navigate to player)
        function openContent(id, type) {
            // Navigate using `type` and `id` query params expected by player.html
            const url = new URL(window.location.href);
            url.pathname = url.pathname.replace(/[^\/]*$/, 'player.html');
            url.searchParams.set('type', type === 'series' ? 'series' : 'movie');
            url.searchParams.set('id', id);
            window.location.href = url.toString();
        }

        // Search functionality
        const searchInput = document.getElementById('search-input');
        let searchTimeout;

        searchInput.addEventListener('input', function() {
            const value = this.value.trim();
            document.getElementById('search-clear').classList.toggle('visible', value.length > 0);
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchTerm = value;
                applyFilters();
                
                // Update URL
                const url = new URL(window.location);
                if (value) {
                    url.searchParams.set('q', value);
                } else {
                    url.searchParams.delete('q');
                }
                history.pushState({}, '', url);
            }, 300);
        });

        // Clear search
        function clearSearch() {
            searchInput.value = '';
            searchTerm = '';
            document.getElementById('search-clear').classList.remove('visible');
            applyFilters();
            
            const url = new URL(window.location);
            url.searchParams.delete('q');
            history.pushState({}, '', url);
        }

        // Reset all filters
        function resetAllFilters() {
            currentTypeFilter = 'all';
            pageSelectedTags = [];
            searchTerm = '';
            
            document.getElementById('search-input').value = '';
            document.getElementById('search-clear').classList.remove('visible');
            document.querySelectorAll('.tag-chip').forEach(chip => chip.classList.remove('active'));
            document.getElementById('clear-tags-btn').disabled = true;
            updateTypeFilterButtons();
            
            history.pushState({}, '', 'catalogo.html');
            applyFilters();
        }

        // Show loading skeleton
        function showLoadingSkeleton() {
            const container = document.getElementById('content-grid');
            container.innerHTML = Array(12).fill('<div class="skeleton-card"></div>').join('');
        }

        // Show empty state
        function showEmptyState() {
            document.getElementById('content-grid').innerHTML = '';
            document.getElementById('empty-state').style.display = 'block';
        }

        // Handle logout
        async function handleLogout() {
            const result = await window.authModule.logoutUser();
            if (result.success) {
                sessionStorage.removeItem('currentProfile');
                window.location.href = 'index.html';
            }
        }

        // Toggle header search
        function toggleHeaderSearch() {
            const container = document.getElementById('header-search-container');
            container.classList.toggle('active');
            if (container.classList.contains('active')) {
                document.getElementById('header-search-input').focus();
            }
        }

        // Handle header search
        function handleHeaderSearch(event) {
            if (event.key === 'Enter') {
                const value = document.getElementById('header-search-input').value.trim();
                if (value) {
                    searchTerm = value;
                    document.getElementById('search-input').value = value;
                    document.getElementById('search-clear').classList.add('visible');
                    applyFilters();
                }
            }
        }

        // Profile modal state
        let catalogProfile = null;
        let selectedAvatar = null;

        // Open profile modal
        function openProfileModal() {
            catalogProfile = JSON.parse(sessionStorage.getItem('currentProfile') || '{}');
            
            // Populate avatar gallery
            const gallery = document.getElementById('avatar-gallery');
            const avatars = window.authModule?.AVATARS || [];
            gallery.innerHTML = avatars.map(avatar => `
                <img src="${avatar.url}" class="avatar-option ${avatar.url === catalogProfile.avatar ? 'selected' : ''}" 
                     onclick="selectAvatar('${avatar.url}', this)" alt="${avatar.name}" title="${avatar.name}">
            `).join('');
            
            // Set current values
            document.getElementById('profile-name-input').value = catalogProfile.name || '';
            document.getElementById('profile-pin-input').value = catalogProfile.pin || '';
            
            // Set kids toggle state
            const kidsToggle = document.getElementById('kids-toggle');
            if (catalogProfile.isKids) {
                kidsToggle.classList.add('active');
            } else {
                kidsToggle.classList.remove('active');
            }
            
            selectedAvatar = catalogProfile.avatar;
            
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('profile-menu').classList.remove('active');
        }

        // Close profile modal
        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        // Select avatar
        function selectAvatar(avatarUrl, element) {
            selectedAvatar = avatarUrl;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        // Toggle kids mode
        function toggleKidsMode() {
            document.getElementById('kids-toggle').classList.toggle('active');
        }

        // Save profile changes
        async function saveProfileChanges() {
            const newName = document.getElementById('profile-name-input').value.trim();
            if (!newName) {
                alert('Nome não pode estar vazio');
                return;
            }

            const newPin = document.getElementById('profile-pin-input').value.trim();
            if (newPin && (newPin.length !== 4 || !/^\d{4}$/.test(newPin))) {
                alert('PIN deve ter 4 dígitos numéricos');
                return;
            }

            const isKids = document.getElementById('kids-toggle').classList.contains('active');

            const updates = { 
                name: newName,
                pin: newPin || '',
                isKids: isKids
            };
            if (selectedAvatar) updates.avatar = selectedAvatar;

            const result = await window.authModule.updateProfile(catalogProfile.id, updates);
            
            if (result.success) {
                catalogProfile = { ...catalogProfile, ...updates };
                sessionStorage.setItem('currentProfile', JSON.stringify(catalogProfile));
                loadProfileAvatar(); // Refresh header avatar
                closeProfileModal();
                alert('Perfil atualizado com sucesso!');
            } else {
                alert('Erro ao salvar: ' + result.error);
            }
        }

        // Profile menu toggle
        function toggleProfileMenu() {
            document.getElementById('profile-menu').classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.profile-dropdown')) {
                document.getElementById('profile-menu').classList.remove('active');
            }
        });

        // Header scroll effect
        window.addEventListener('scroll', function() {
            const header = document.getElementById('header');
            if (window.scrollY > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });
    </script>

</body>

</html>
