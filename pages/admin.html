<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Painel Administrativo - Cruciflix">
    <title>Admin - Cruciflix</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/admin.css">
    <link rel="stylesheet" href="../styles/responsive.css">
</head>

<body>

    <!-- Header Navigation -->
    <header class="main-header">
        <div class="container">
            <nav class="nav-container">
                <div class="logo" onclick="window.location.href='dashboard.html'" style="cursor: pointer;">
                    Cruci<span class="accent">flix</span> <span style="font-size: 0.6em; color: var(--color-secondary);">Admin</span>
                </div>

                <div class="user-menu">
                    <div class="user-menu-btn" id="user-menu-btn">
                        <div class="user-avatar" id="user-avatar">A</div>
                    </div>
                    <div class="user-menu-dropdown" id="user-menu-dropdown">
                        <a href="dashboard.html">Voltar ao Dashboard</a>
                        <a href="catalogo.html">Cat√°logo</a>
                        <a href="#" onclick="handleLogout(event)">Sair</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="admin-page">
        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar">
            <nav class="admin-nav">
                <a href="#" class="admin-nav-link active" onclick="showSection('videos', event)">
                    <span class="nav-icon">üé¨</span>
                    <span>V√≠deos</span>
                </a>
                <a href="#" class="admin-nav-link" onclick="showSection('upload', event)">
                    <span class="nav-icon">üì§</span>
                    <span>Upload HLS</span>
                </a>
                <a href="#" class="admin-nav-link" onclick="showSection('users', event)">
                    <span class="nav-icon">üë•</span>
                    <span>Usu√°rios</span>
                </a>
                <a href="#" class="admin-nav-link" onclick="showSection('comments', event)">
                    <span class="nav-icon">üí¨</span>
                    <span>Coment√°rios</span>
                </a>
                <a href="#" class="admin-nav-link" onclick="showSection('analytics', event)">
                    <span class="nav-icon">üìä</span>
                    <span>Analytics</span>
                </a>
            </nav>
        </aside>

        <div class="admin-container">
            <!-- Videos Section -->
            <section id="section-videos" class="admin-content-section">
                <div class="admin-header">
                    <h1 class="admin-title">Gerenciar V√≠deos</h1>
                    <p class="admin-description">Adicionar, editar e remover v√≠deos</p>
                </div>

                <!-- Add Video Form -->
                <div class="admin-section">
                    <div class="admin-section-header">
                        <h2 class="admin-section-title">Adicionar Novo V√≠deo</h2>
                    </div>

                    <form id="add-video-form" onsubmit="window.adminModule.handleAddVideoForm(event)">
                        <div class="admin-form-grid">
                            <div class="form-group">
                                <label class="form-label">T√≠tulo *</label>
                                <input type="text" name="title" class="form-input" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">URL do HLS (.m3u8) *</label>
                                <input type="url" name="hlsUrl" class="form-input" placeholder="https://..." required>
                            </div>

                            <div class="form-group admin-form-full">
                                <label class="form-label">Descri√ß√£o *</label>
                                <textarea name="description" class="form-textarea" rows="3" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tags (separadas por v√≠rgula) *</label>
                                <input type="text" name="tags" class="form-input" placeholder="Filme, Medieval, Santo" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">URL da Miniatura</label>
                                <input type="url" name="thumbnailUrl" class="form-input" placeholder="https://...">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Dura√ß√£o (segundos)</label>
                                <input type="number" name="duration" class="form-input" value="0">
                            </div>

                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="isKidsSafe">
                                    <span>Seguro para crian√ßas</span>
                                </label>
                            </div>
                        </div>

                        <div class="admin-form-actions">
                            <button type="submit" class="btn btn-primary">Adicionar V√≠deo</button>
                        </div>
                    </form>
                </div>

                <!-- Videos List -->
                <div class="admin-section">
                    <div class="admin-section-header">
                        <h2 class="admin-section-title">V√≠deos Cadastrados</h2>
                    </div>

                    <div class="admin-table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>T√≠tulo</th>
                                    <th>Tags</th>
                                    <th>Visualiza√ß√µes</th>
                                    <th>Kids</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="videos-table-body">
                                <!-- Rows loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Upload HLS Video Section -->
            <section id="section-upload" class="admin-content-section" style="display:none;">
                <div class="admin-header">
                    <h1 class="admin-title">Upload de V√≠deo HLS</h1>
                    <p class="admin-description">Fa√ßa upload e processe v√≠deos para streaming HLS</p>
                </div>

                <div class="admin-section">
                    <div class="admin-section-header">
                        <h2 class="admin-section-title">Enviar e Processar V√≠deo</h2>
                    </div>

                    <form id="upload-hls-form" onsubmit="window.adminModule.handleUploadForm(event)">
                        <div class="admin-form-grid">
                            <!-- Video File -->
                            <div class="form-group admin-form-full">
                                <label class="form-label">Arquivo de V√≠deo *</label>
                                <input type="file" name="videoFile" class="form-input" accept="video/*" required onchange="window.adminModule.handleFileSelect(event)">
                                <small class="form-hint">Formato aceito: MP4, MOV, AVI, MKV (Max: 2GB)</small>
                            </div>

                            <!-- Video Info -->
                            <div class="form-group">
                                <label class="form-label">T√≠tulo *</label>
                                <input type="text" name="title" class="form-input" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tags (separadas por v√≠rgula) *</label>
                                <input type="text" name="tags" class="form-input" placeholder="Filme, Medieval, Santo" required>
                            </div>

                            <div class="form-group admin-form-full">
                                <label class="form-label">Descri√ß√£o *</label>
                                <textarea name="description" class="form-textarea" rows="3" required></textarea>
                            </div>

                            <!-- Processing Settings -->
                            <div class="form-group">
                                <label class="form-label">Qualidade de Codifica√ß√£o</label>
                                <select name="quality" class="form-input">
                                    <option value="fast">R√°pida (Lower Quality)</option>
                                    <option value="medium" selected>M√©dia (Balanced)</option>
                                    <option value="slow">Alta (Better Quality)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Resolu√ß√µes</label>
                                <div class="checkbox-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" name="res_360p" checked>
                                        <span>360p</span>
                                    </label>
                                    <label class="form-checkbox">
                                        <input type="checkbox" name="res_480p" checked>
                                        <span>480p</span>
                                    </label>
                                    <label class="form-checkbox">
                                        <input type="checkbox" name="res_720p" checked>
                                        <span>720p</span>
                                    </label>
                                    <label class="form-checkbox">
                                        <input type="checkbox" name="res_1080p">
                                        <span>1080p</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Kids Safe & Thumbnail -->
                            <div class="form-group">
                                <label class="form-label">URL da Miniatura (opcional)</label>
                                <input type="url" name="thumbnailUrl" class="form-input" placeholder="https://...">
                                <small class="form-hint">Deixe em branco para gerar automaticamente</small>
                            </div>

                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="isKidsSafe">
                                    <span>Seguro para crian√ßas</span>
                                </label>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div id="upload-progress-container" style="display:none; margin-top: 20px;">
                            <div class="progress-info">
                                <span id="progress-status">Preparando...</span>
                                <span id="progress-percentage">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="progress-fill" class="progress-fill"></div>
                            </div>
                            <small id="progress-details" class="form-hint"></small>
                        </div>

                        <div class="admin-form-actions">
                            <button type="submit" class="btn btn-primary" id="upload-submit-btn">
                                Processar e Enviar V√≠deo
                            </button>
                            <button type="button" class="btn btn-secondary" id="upload-cancel-btn" style="display:none;" onclick="window.adminModule.cancelUpload()">
                                Cancelar Upload
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Users Section -->
            <section id="section-users" class="admin-content-section" style="display:none;">
                <div class="admin-header">
                    <h1 class="admin-title">Gerenciar Usu√°rios</h1>
                    <p class="admin-description">Visualizar e gerenciar contas de usu√°rio</p>
                </div>

                <div class="admin-section">
                    <div class="admin-table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Data de Cria√ß√£o</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Rows loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Comments Section -->
            <section id="section-comments" class="admin-content-section" style="display:none;">
                <div class="admin-header">
                    <h1 class="admin-title">Moderar Coment√°rios</h1>
                    <p class="admin-description">Aprovar ou remover coment√°rios</p>
                </div>

                <div class="admin-section">
                    <div class="admin-table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Usu√°rio</th>
                                    <th>Coment√°rio</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="comments-table-body">
                                <!-- Rows loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="section-analytics" class="admin-content-section" style="display:none;">
                <div class="admin-header">
                    <h1 class="admin-title">Analytics</h1>
                    <p class="admin-description">Estat√≠sticas e m√©tricas do sistema</p>
                </div>

                <div class="admin-section">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-icon">üé¨</div>
                            <div class="analytics-value" id="analytics-videos">0</div>
                            <div class="analytics-label">V√≠deos</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">üë•</div>
                            <div class="analytics-value" id="analytics-users">0</div>
                            <div class="analytics-label">Usu√°rios</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">üëÅÔ∏è</div>
                            <div class="analytics-value" id="analytics-views">0</div>
                            <div class="analytics-label">Visualiza√ß√µes</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">üí¨</div>
                            <div class="analytics-value" id="analytics-comments">0</div>
                            <div class="analytics-label">Coment√°rios</div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- App Scripts (Consolidated) -->
    <script src="../scripts/app-core.js"></script>
    <script src="../scripts/app-catalog.js"></script>
    <script src="../scripts/app-admin.js"></script>

    <script>
        // Protect page - require admin access
        window.authModule.onAuthStateChanged(async (authState) => {
            if (!authState.loggedIn) {
                window.location.href = 'index.html';
                return;
            }

            if (!authState.isAdmin) {
                window.uiModule.showToast('Acesso negado. Apenas administradores.', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 2000);
                return;
            }

            // Update user avatar
            const user = authState.user;
            const initials = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;

            // Setup user menu toggle
            setupUserMenu();

            // Load dashboard data
            loadDashboard();
        });

        // Setup user menu
        function setupUserMenu() {
            const menuBtn = document.getElementById('user-menu-btn');
            const dropdown = document.getElementById('user-menu-dropdown');
            
            menuBtn.addEventListener('click', () => {
                dropdown.classList.toggle('show');
            });
            
            document.addEventListener('click', (e) => {
                if (!menuBtn.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Load dashboard
        async function loadDashboard() {
            await window.adminModule.loadAnalytics();
            await window.adminModule.loadAdminVideos();
            await window.adminModule.loadUsers();
            await window.adminModule.loadCommentsForModeration();
        }

        // Show section
        function showSection(section, event) {
            if (event) event.preventDefault();
            
            // Hide all sections
            document.querySelectorAll('.admin-content-section').forEach(s => {
                s.style.display = 'none';
            });

            // Remove active class from all nav links
            document.querySelectorAll('.admin-nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            const sectionEl = document.getElementById('section-' + section);
            if (sectionEl) {
                sectionEl.style.display = 'block';
            }

            // Add active class to clicked link
            if (event && event.target) {
                event.target.closest('.admin-nav-link').classList.add('active');
            }
        }

        // Make admin functions available globally
        window.editVideo = window.adminModule.editVideo;
        window.confirmDeleteVideo = (id, title) => {
            if (confirm(`Tem certeza que deseja excluir "${title}"?`)) {
                window.adminModule.deleteVideo(id);
            }
        };

        window.toggleUserRole = window.adminModule.toggleUserRole;
        window.confirmDeleteUser = (id, email) => {
            if (confirm(`Tem certeza que deseja excluir o usu√°rio "${email}"?`)) {
                window.adminModule.deleteUser(id);
            }
        };

        window.approveComment = window.adminModule.approveComment;
        window.confirmDeleteComment = (id) => {
            if (confirm('Tem certeza que deseja excluir este coment√°rio?')) {
                window.adminModule.deleteCommentAdmin(id);
            }
        };

        // Handle logout
        async function handleLogout(event) {
            event.preventDefault();
            const result = await window.authModule.logoutUser();
            if (result.success) {
                window.location.href = 'index.html';
            }
        }
    </script>

</body>

</html>